<!-- ç‚¹æ­Œç®¡ç†é¡µé¢ -->
<view class="song-manage-container">
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-cards">
    <view class="stat-card">
      <text class="stat-number">{{queueCount}}</text>
      <text class="stat-label">æ’­æ”¾é˜Ÿåˆ—</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{totalRequests}}</text>
      <text class="stat-label">æ€»ç‚¹æ­Œæ•°</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{currentSong ? 'æ’­æ”¾ä¸­' : 'ç©ºé—²'}}</text>
      <text class="stat-label">æ’­æ”¾çŠ¶æ€</text>
    </view>
  </view>

  <!-- å½“å‰æ’­æ”¾ -->
  <view class="current-playing" wx:if="{{currentSong}}">
    <view class="section-title">
      <text class="title-text">æ­£åœ¨æ’­æ”¾</text>
      <text class="playing-indicator">ğŸµ</text>
    </view>
    <view class="song-card current">
      <view class="song-info">
        <text class="song-title">{{currentSong.title}}</text>
        <text class="song-artist">{{currentSong.artist}}</text>
        <text class="song-requester">ç‚¹æ­Œäºº: {{currentSong.requester_name}}</text>
      </view>
      <view class="song-actions">
        <button class="action-btn skip-btn" bindtap="skipSong">è·³è¿‡</button>
      </view>
    </view>
  </view>

  <!-- æ’­æ”¾é˜Ÿåˆ— -->
  <view class="queue-section">
    <view class="section-header">
      <text class="section-title">æ’­æ”¾é˜Ÿåˆ— ({{queueList.length}})</text>
      <button class="manage-btn" bindtap="clearQueue" wx:if="{{queueList.length > 0}}">
        æ¸…ç©ºé˜Ÿåˆ—
      </button>
    </view>

    <scroll-view class="queue-list" scroll-y="{{true}}" wx:if="{{queueList.length > 0}}">
      <view class="song-card" wx:for="{{queueList}}" wx:key="id" wx:for-index="index">
        <view class="queue-number">{{index + 1}}</view>
        <view class="song-info">
          <text class="song-title">{{item.title}}</text>
          <text class="song-artist">{{item.artist}}</text>
          <text class="song-requester">ç‚¹æ­Œäºº: {{item.requester_name}}</text>
          <text class="song-time">{{formatTime(item.created_at)}}</text>
        </view>
        <view class="song-actions">
          <button class="action-btn priority-btn" bindtap="setPriority" data-id="{{item.id}}">
            ç½®é¡¶
          </button>
          <button class="action-btn remove-btn" bindtap="removeFromQueue" data-id="{{item.id}}">
            ç§»é™¤
          </button>
        </view>
      </view>
    </scroll-view>

    <view class="empty-queue" wx:if="{{queueList.length === 0}}">
      <text class="empty-icon">ğŸµ</text>
      <text class="empty-text">æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º</text>
      <text class="empty-desc">ç”¨æˆ·ç‚¹æ­Œåä¼šè‡ªåŠ¨æ·»åŠ åˆ°é˜Ÿåˆ—</text>
    </view>
  </view>

  <!-- æ­Œæ›²å®¡æ ¸ -->
  <view class="review-section">
    <view class="section-header">
      <text class="section-title">æ­Œæ›²å®¡æ ¸</text>
      <view class="filter-buttons">
        <button class="filter-btn {{reviewFilter === 'pending' ? 'active' : ''}}" 
                bindtap="switchReviewFilter" data-filter="pending">
          å¾…å®¡æ ¸
        </button>
        <button class="filter-btn {{reviewFilter === 'approved' ? 'active' : ''}}" 
                bindtap="switchReviewFilter" data-filter="approved">
          å·²é€šè¿‡
        </button>
        <button class="filter-btn {{reviewFilter === 'rejected' ? 'active' : ''}}" 
                bindtap="switchReviewFilter" data-filter="rejected">
          å·²æ‹’ç»
        </button>
      </view>
    </view>

    <scroll-view class="review-list" scroll-y="{{true}}" refresher-enabled="{{true}}"
                 refresher-triggered="{{refreshingReview}}" bindrefresherrefresh="onRefreshReview"
                 bindscrolltolower="loadMoreReviews">
      
      <view class="song-card review" wx:for="{{reviewList}}" wx:key="id">
        <view class="song-info">
          <text class="song-title">{{item.song_name}}</text>
          <text class="song-requester">ç‚¹æ­Œäºº: {{item.user_name}} ({{item.user_student_id}})</text>
          <text class="song-time">{{formatTime(item.request_time)}}</text>
          <text class="review-reason" wx:if="{{item.review_reason}}">ç†ç”±: {{item.review_reason}}</text>
        </view>
        <view class="song-actions" wx:if="{{item.status === 'pending'}}">
          <button class="action-btn approve-btn" bindtap="approveSong" data-id="{{item.id}}">
            é€šè¿‡
          </button>
          <button class="action-btn reject-btn" bindtap="rejectSong" data-id="{{item.id}}">
            æ‹’ç»
          </button>
        </view>
        <view class="song-status" wx:else>
          <text class="status-text status-{{item.status}}">{{getStatusText(item.status)}}</text>
          <text class="review-time" wx:if="{{item.review_time}}">{{formatTime(item.review_time)}}</text>
        </view>
      </view>

      <view class="loading-more" wx:if="{{loadingReview}}">
        <text>åŠ è½½ä¸­...</text>
      </view>

      <view class="no-more" wx:if="{{!hasMoreReviews && reviewList.length > 0}}">
        <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
      </view>

      <view class="empty-review" wx:if="{{!loadingReview && reviewList.length === 0}}">
        <text class="empty-icon">ğŸµ</text>
        <text class="empty-text">{{reviewFilter === 'pending' ? 'æš‚æ— å¾…å®¡æ ¸æ­Œæ›²' : 'æš‚æ— è®°å½•'}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- ç‚¹æ­Œå†å² -->
  <view class="history-section">
    <view class="section-header">
      <text class="section-title">ç‚¹æ­Œå†å²</text>
      <view class="filter-buttons">
        <button class="filter-btn {{historyFilter === 'all' ? 'active' : ''}}" 
                bindtap="switchHistoryFilter" data-filter="all">
          å…¨éƒ¨
        </button>
        <button class="filter-btn {{historyFilter === 'today' ? 'active' : ''}}" 
                bindtap="switchHistoryFilter" data-filter="today">
          ä»Šæ—¥
        </button>
      </view>
    </view>

    <scroll-view class="history-list" scroll-y="{{true}}" refresher-enabled="{{true}}"
                 refresher-triggered="{{refreshing}}" bindrefresherrefresh="onRefresh"
                 bindscrolltolower="loadMoreHistory">
      
      <view class="song-card history" wx:for="{{historyList}}" wx:key="id">
        <view class="song-info">
          <text class="song-title">{{item.title}}</text>
          <text class="song-artist">{{item.artist}}</text>
          <text class="song-requester">ç‚¹æ­Œäºº: {{item.requester_name}}</text>
          <text class="song-time">{{formatTime(item.created_at)}}</text>
        </view>
        <view class="song-status">
          <text class="status-text status-{{item.status}}">{{getStatusText(item.status)}}</text>
        </view>
      </view>

      <view class="loading-more" wx:if="{{loadingHistory}}">
        <text>åŠ è½½ä¸­...</text>
      </view>

      <view class="no-more" wx:if="{{!hasMoreHistory && historyList.length > 0}}">
        <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
      </view>

      <view class="empty-history" wx:if="{{!loadingHistory && historyList.length === 0}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">æš‚æ— ç‚¹æ­Œè®°å½•</text>
      </view>
    </scroll-view>
  </view>

  <!-- æ’­æ”¾æ§åˆ¶é¢æ¿ -->
  <view class="control-panel">
    <button class="control-btn" bindtap="pausePlay">
      {{isPlaying ? 'æš‚åœ' : 'æ’­æ”¾'}}
    </button>
    <button class="control-btn" bindtap="nextSong">ä¸‹ä¸€é¦–</button>
    <button class="control-btn" bindtap="toggleShuffle">
      {{shuffleMode ? 'å–æ¶ˆéšæœº' : 'éšæœºæ’­æ”¾'}}
    </button>
  </view>

  <!-- å®¡æ ¸ç†ç”±å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showRejectModal}}" bindtap="hideRejectModal">
    <view class="modal-content" catchtap="preventModalClose">
      <view class="modal-header">
        <text class="modal-title">æ‹’ç»ç†ç”±</text>
        <button class="modal-close" bindtap="hideRejectModal">Ã—</button>
      </view>
      <view class="modal-body">
        <textarea class="reason-input" 
                  placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆé€‰å¡«ï¼‰" 
                  value="{{rejectReason}}" 
                  bindinput="onReasonInput"
                  maxlength="200">
        </textarea>
        <text class="char-count">{{rejectReason.length}}/200</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideRejectModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmReject">ç¡®è®¤æ‹’ç»</button>
      </view>
    </view>
  </view>
</view>